<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¨¡æ‹ŸçŸ­è§†é¢‘è°ƒç ”ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
        :root {
            --douyin-red: #fe2c55;
            --douyin-black: #161823;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100%; background: #000; overflow: hidden;         font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; }

        .nav-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 50px;
            display: flex; align-items: center; overflow-x: auto; 
            white-space: nowrap; z-index: 100; background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
            padding: 0 10px; scrollbar-width: none;
        }
        .nav-item {
            color: rgba(255,255,255,0.7); padding: 10px 15px; font-size: 16px; font-weight: bold; cursor: pointer;
        }
        .nav-item.active { color: #fff; border-bottom: 2px solid #fff; }

        .swiper { width: 100%; height: 100%; }
        .swiper-slide { position: relative; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }

        .side-bar {
            position: absolute; right: 10px; bottom: 150px; 
            display: flex; flex-direction: column; gap: 20px; z-index: 10;
        }
        .side-icon { text-align: center; color: #fff; font-size: 12px; }
        .icon-circle { width: 45px; height: 45px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 5px; cursor: pointer; transition: all 0.3s; }
        .icon-circle.liked { color: var(--douyin-red); background: rgba(254,44,85,0.3); }
        .icon-circle:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        .comment-item { padding:10px 0; border-bottom:1px solid #eee; }
        .comment-item:last-child { border-bottom:none; }
        .comment-user { font-weight:bold; color:#333; margin-bottom:5px; }
        .comment-content { color:#666; font-size:14px; }
        .comment-time { color:#999; font-size:12px; margin-top:5px; }

        .bottom-info {
            position: absolute; left: 10px; bottom: 30px; width: 70%;
            color: #fff; z-index: 10; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .user-name { font-size: 17px; font-weight: bold; margin-bottom: 8px; }
        .video-desc { font-size: 14px; margin-bottom: 12px; line-height: 1.4; }
        .team-up-btn {
            display: inline-block; padding: 8px 16px; background: var(--douyin-red);
            border-radius: 20px; font-weight: bold; font-size: 14px; animation: pulse 2s infinite;
        }

        .danmaku-container { position: absolute; top: 80px; width: 100%; height: 200px; pointer-events: none; z-index: 5; }
        .danmaku-item {
            position: absolute; white-space: nowrap; color: #fff; text-shadow: 1px 1px 2px #000;
            font-size: 14px; animation: danmaku-move linear forwards;
        }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-body { width: 85%; background: #fff; border-radius: 16px; padding: 25px; color: #333; }

        .matching-ui { text-align: center; color: #fff; }
        .radar {
            width: 120px; height: 120px; border: 2px solid var(--douyin-red); border-radius: 50%;
            margin: 0 auto 20px; position: relative; animation: radar-spin 2s linear infinite;
        }
        .radar::after { content: ''; position: absolute; top: 50%; left: 50%; width: 50%; height: 2px; background: var(--douyin-red); transform-origin: left center; }

        @keyframes danmaku-move { from { transform: translateX(100vw); } to { transform: translateX(-150%); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes radar-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .survey-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #000; }
        .survey-item { margin-bottom: 15px; }
        .survey-item label { display: block; margin: 8px 0; }
        .submit-btn { width: 100%; background: var(--douyin-red); color: #fff; border: none; padding: 12px; border-radius: 8px; font-weight: bold; }

        @media (min-width: 768px) {
            body {
                display: flex;
                justify-content: center;
                align-items: center;
                background: #000;
            }
            
            .swiper {
                max-width: 450px;
                height: 100vh;
                margin: 0 auto;
            }
            
            .swiper-slide {
                background: #000;
            }
            
            video {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }
            
            .nav-bar {
                max-width: 450px;
                left: 50%;
                transform: translateX(-50%);
            }
        }
    </style>
</head>
<body>

    <div class="nav-bar" id="navBar">
        <div class="nav-item active" onclick="filterCategory('æ¨è', this)">æ¨è</div>
        <div class="nav-item" onclick="filterCategory('ç¾é£Ÿ', this)">ç¾é£Ÿ</div>
        <div class="nav-item" onclick="filterCategory('å­¦ä¹ ', this)">å­¦ä¹ </div>
        <div class="nav-item" onclick="filterCategory('æ—…è¡Œ', this)">æ—…è¡Œ</div>
        <div class="nav-item" onclick="filterCategory('æ¸¸æˆ', this)">æ¸¸æˆ</div>
        <div class="nav-item" onclick="filterCategory('æ ¡å›­ç”Ÿæ´»', this)">æ ¡å›­ç”Ÿæ´»</div>
    </div>

    <div class="swiper">
        <div class="swiper-wrapper" id="videoWrapper">
            </div>
    </div>

    <div id="surveyModal" class="modal">
        <div class="modal-body">
            <div class="survey-title">è§†é¢‘åé¦ˆè°ƒç ”</div>
            <div class="survey-item">
                <p>1. ä½ åˆšæ‰çœ‹åˆ°çš„è§†é¢‘å±äºå“ªä¸€ç±»ï¼Ÿ</p>
                <label><input type="radio" name="cat" value="ç¾é£Ÿ"> ç¾é£Ÿ</label>
                <label><input type="radio" name="cat" value="å­¦ä¹ "> å­¦ä¹ </label>
                <label><input type="radio" name="cat" value="æ—…è¡Œ"> æ—…è¡Œ</label>
                <label><input type="radio" name="cat" value="æ¸¸æˆ"> æ¸¸æˆ</label>
                <label><input type="radio" name="cat" value="æ ¡å›­ç”Ÿæ´»"> æ ¡å›­ç”Ÿæ´»</label>
            </div>
            <div class="survey-item">
                <p>2. ä½ å–œæ¬¢è¿™ä¸ªè§†é¢‘å—ï¼Ÿç†ç”±æ˜¯ï¼Ÿ</p>
                <textarea id="reason" style="width:100%; height:60px; border:1px solid #ddd; border-radius:4px;"></textarea>
            </div>
            <button class="submit-btn" onclick="submitSurvey()">æäº¤å¹¶ç»§ç»­è§‚çœ‹</button>
        </div>
    </div>

    <div id="matchModal" class="modal">
        <div id="matchingUI" class="matching-ui">
            <div class="radar"></div>
            <p>æ­£åœ¨åŒ¹é… <span id="matchProgress">1/4äºº</span></p>
        </div>
        <div id="matchResult" class="modal-body" style="display:none; text-align:center;">
            <div style="font-size:40px;">ğŸ‰</div>
            <h3 style="margin:10px 0;">åŒ¹é…æˆåŠŸï¼</h3>
            <img id="m-avatar" src="" style="width:80px; height:80px; border-radius:50%; border:3px solid var(--douyin-red);">
            <p style="font-weight:bold; margin:10px 0;" id="m-name"></p>
            <p style="color:#666; font-size:13px;">åŒ¹é…åº¦ï¼š<span id="m-rate" style="color:var(--douyin-red)"></span></p>
            <button class="submit-btn" onclick="closeModal('matchModal')">å‘é€æ‰“æ‹›å‘¼</button>
        </div>
    </div>

    <div id="commentModal" class="modal">
        <div class="modal-body" style="max-height:80vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div class="survey-title">è¯„è®º</div>
                <button onclick="closeModal('commentModal')" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div id="commentsList" style="margin-bottom:20px; max-height:400px; overflow-y:auto;">
            </div>
            <div style="border-top:1px solid #eee; padding-top:15px;">
                <textarea id="newComment" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." style="width:100%; height:60px; border:1px solid #ddd; border-radius:4px; padding:8px; margin-bottom:10px;"></textarea>
                <button class="submit-btn" onclick="addComment()">å‘å¸ƒè¯„è®º</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        const videoData = [
            { id: 1, cat: "ç¾é£Ÿ", url: "03_ç¾é£Ÿ.mp4", user: "@chef chen", desc: "çˆ±åƒ å¥½åƒ #æ¾³é—¨#æ¾³é—¨ç¾é£Ÿ#æ¾³é—¨æ—…æ¸¸#æ¾³é—¨æ—…æ¸¸æ”»ç•¥", danmaku: ["çœ‹èµ·æ¥å¾ˆå¥½åƒ", "åœ¨å“ªé‡Œ", "å¤šå°‘é’±", "æƒ³å»è¯•è¯•"], team: { name: "ç¾é£Ÿæ¢åº—å›¢", rate: "95%", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=1" } },
            { id: 2, cat: "ç¾é£Ÿ", url: "08_ç¾é£Ÿ.mp4", user: "@ç¾é£Ÿåšä¸»", desc: "æˆ‘å®£å¸ƒï¼Œè¿™æ˜¯æˆ‘è¿‘æœŸåƒè¿‡æœ€å¹³ä»·çš„æ¼‚äº®åº—ï¼", danmaku: ["çœ‹èµ·æ¥å¾ˆå¥½åƒ", "æ±‚åœ°å€", "å¤ªé¦™äº†", "æ”¶è—äº†"], team: { name: "ç¾é£Ÿè¾¾äºº", rate: "93%", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=2" } },
            { id: 3, cat: "å­¦ä¹ ", url: "04_å­¦ä¹ .mp4", user: "@Hadeså’Œ33", desc: "ä¸ç®¡æœ‰å¤šéš¾,éƒ½æ˜¯å€¼å¾—çš„!ç»§ç»­åŠªåŠ›! #çƒ­é—¨æ³•å­¦é™¢æ¯•ä¸šç”Ÿ #æ³•å¾‹ç³»å­¦ç”Ÿ #å­¦ä¹ åŠ¨æœº#åŠ±å¿—è§†é¢‘", danmaku: ["åŠ æ²¹", "æ”¶è—äº†", "å¾ˆæœ‰ç”¨", "å…±å‹‰"], team: { name: "å­¦ä¹ ä¼™ä¼´", rate: "92%", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=3" } },
            { id: 4, cat: "æ—…è¡Œ", url: "01_æ—…è¡Œ.mp4", user: "@æ¢é¬¼é¬¼", desc: "é•¿è¿™ä¹ˆå¤§ç¬¬ä¸€æ¬¡è§æ˜æ˜Ÿ æœ¬äººè¿˜æŒºæ¼‚äº®çš„#æ¨è¶…è¶Š", danmaku: ["å¥½æƒ³å»", "æ”»ç•¥æ”¶è—", "å¤ªç¾äº†", "æ±‚åœ°å€"], team: { name: "è¿½æ˜Ÿå°åˆ†é˜Ÿ", rate: "96%", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=4" } },
            { id: 5, cat: "æ—…è¡Œ", url: "05_æ—…è¡Œ.mp4", user: "@é‡Šè¿¦çš„æ‚...", desc: "ç¬¬28é›†|è¯„æµ‹:æ¾³é—¨å„å¤§èµŒåœºçš„è¹­åƒå–èµ°ä¸€éäº†,å¦‚æœåªæ˜¯ä¸ºäº†è¹­åƒå–,äººè¯¥æ˜¯ç›´å¥”ç¾...", danmaku: ["å¥½æƒ³å»", "æ”»ç•¥æ”¶è—", "æƒ³å»", "å¤ªå®ç”¨äº†"], team: { name: "æ—…è¡Œæ”»ç•¥ç»„", rate: "94%", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=5" } },
            { id: 6, cat: "æ—…è¡Œ", url: "07_æ—…è¡Œ.mp4", user: "@çŒªä¸½è€¶", desc: "å¿«æ¥ç æµ·é•¿éš†æµ·æ´‹ç‹å›½å§,ç°åœ¨æœ‰395ä¸¤ä¸ªäººçš„é—¨ç¥¨,åˆ«é”™è¿‡äº†~#ç æµ·é•¿éš†æµ·æ´‹ç‹å›½ #ç æµ·...", danmaku: ["å¥½æƒ³å»", "åˆ’ç®—", "å·²ä¹°ç¥¨", "æ±‚æ”»ç•¥"], team: { name: "æ—…è¡Œæ­å­", rate: "97%", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=6" } },
            { id: 7, cat: "æ ¡å›­ç”Ÿæ´»", url: "02_æ ¡å›­ç”Ÿæ´».mp4", user: "@Elma.Z", desc: "è¿™å“¥ä»¬å„¿åœ¨å¹²å˜›", danmaku: ["åŒæ ¡", "å¥½ç¾¡æ…•", "ç‚¹èµ", "æ”¯æŒ"], team: { name: "æ ¡å›­è½¦å‹", rate: "88%", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=7" } },
            { id: 8, cat: "æ ¡å›­ç”Ÿæ´»", url: "06_æ ¡å›­ç”Ÿæ´».mp4", user: "@é»„èŠ±èœ", desc: "ä¸Šæµ·å•†èµ›#å•†èµ›#å•†ä¸šæ¨¡æ‹ŸæŒ‘æˆ˜èµ› #CEO", danmaku: ["åŒæ ¡", "å¥½ç¾¡æ…•", "ç‚¹èµ", "æ”¯æŒ"], team: { name: "å•†èµ›é˜Ÿå‹", rate: "90%", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=8" } },
        ];
        let videoStats = {};
        let videoComments = {};

        let currentCategory = "æ¨è";
        let watchedCount = 0;
        let swiper;

        function initSwiper(data) {
            const wrapper = document.getElementById('videoWrapper');
            wrapper.innerHTML = data.map((item, index) => {
                const videoId = item.id;
                const stats = videoStats[videoId] || { likes: 0, comments: 0, shares: 0 };
                const isLiked = localStorage.getItem(`liked_${videoId}`) === 'true';
                return `
                <div class="swiper-slide" data-id="${videoId}">
                    <video loop playsinline src="${item.url}" poster="https://via.placeholder.com/400x800/000000/FFFFFF?text=Loading..."></video>
                    <div class="danmaku-container"></div>
                    <div class="side-bar">
                        <div class="side-icon">
                            <div class="icon-circle ${isLiked ? 'liked' : ''}" onclick="toggleLike(${videoId}, ${index})" id="likeBtn_${videoId}">â¤ï¸</div>
                            <span id="likeCount_${videoId}">${formatCount(stats.likes)}</span>
                        </div>
                        <div class="side-icon">
                            <div class="icon-circle" onclick="showComments(${videoId})">ğŸ’¬</div>
                            <span id="commentCount_${videoId}">${formatCount(stats.comments)}</span>
                        </div>
                        <div class="side-icon">
                            <div class="icon-circle" onclick="shareVideo(${videoId})">ğŸ”—</div>
                            <span id="shareCount_${videoId}">${formatCount(stats.shares)}</span>
                        </div>
                    </div>
                    <div class="bottom-info">
                        <div class="user-name">${item.user}</div>
                        <div class="video-desc">${item.desc}</div>
                        <div class="team-up-btn" onclick="startMatch(${item.id})">ğŸ¤ ä¸€èµ·ç»„é˜Ÿæ¢åº—</div>
                    </div>
                </div>
            `;
            }).join('');

            if (swiper) swiper.destroy();
            swiper = new Swiper('.swiper', {
                direction: 'vertical',
                on: {
                    slideChange: function() {
                        const prevVideo = document.querySelectorAll('video')[this.previousIndex];
                        if(prevVideo) prevVideo.pause();
                        
                        const currentVideo = document.querySelectorAll('video')[this.activeIndex];
                        currentVideo.play();
                        
                        watchedCount++;
                        if(watchedCount % 5 === 0) {
                            currentVideo.pause();
                            document.getElementById('surveyModal').style.display = 'flex';
                        }
                        const slide = this.slides[this.activeIndex];
                        const vid = slide ? parseInt(slide.getAttribute('data-id'), 10) : null;
                        if (vid != null) sendDanmaku(vid);
                    }
                }
            });
            document.querySelectorAll('video')[0].play();
            const firstSlide = document.querySelector('.swiper-slide[data-id]');
            if (firstSlide) sendDanmaku(parseInt(firstSlide.getAttribute('data-id'), 10));
        }

        function sendDanmaku(videoId) {
            const item = videoData.find(v => v.id === videoId);
            if (!item || !item.danmaku) return;
            const slides = document.querySelectorAll('.swiper-slide');
            let container = null;
            for (let i = 0; i < slides.length; i++) {
                if (parseInt(slides[i].getAttribute('data-id'), 10) === videoId) {
                    container = slides[i].querySelector('.danmaku-container');
                    break;
                }
            }
            if (!container) return;
            const texts = item.danmaku;
            const currentVideoId = videoId;
            setInterval(() => {
                if (!swiper || !swiper.slides[swiper.activeIndex]) return;
                const activeId = parseInt(swiper.slides[swiper.activeIndex].getAttribute('data-id'), 10);
                if (activeId !== currentVideoId) return;
                const span = document.createElement('span');
                span.className = 'danmaku-item';
                span.innerText = texts[Math.floor(Math.random()*texts.length)];
                span.style.top = Math.random() * 150 + 'px';
                span.style.animationDuration = (Math.random() * 3 + 4) + 's';
                container.appendChild(span);
                setTimeout(() => span.remove(), 7000);
            }, 2000);
        }

        function startMatch(videoId) {
            const video = document.querySelectorAll('video')[swiper.activeIndex];
            if (video) video.pause();
            const modal = document.getElementById('matchModal');
            const ui = document.getElementById('matchModal').querySelector('#matchingUI');
            const res = document.getElementById('matchResult');
            const progressEl = document.getElementById('matchProgress');
            
            modal.style.display = 'flex';
            ui.style.display = 'block';
            res.style.display = 'none';
            if (progressEl) progressEl.textContent = '1/4äºº';

            const t1 = setTimeout(() => { if (progressEl) progressEl.textContent = '2/4äºº'; }, 500);
            const t2 = setTimeout(() => { if (progressEl) progressEl.textContent = '3/4äºº'; }, 1000);
            const t3 = setTimeout(() => { if (progressEl) progressEl.textContent = '4/4äºº'; }, 1500);
            setTimeout(() => {
                clearTimeout(t1);
                clearTimeout(t2);
                clearTimeout(t3);
                const item = videoData.find(v => v.id === videoId);
                if (item && item.team) {
                    document.getElementById('m-name').innerText = item.team.name;
                    document.getElementById('m-rate').innerText = item.team.rate;
                    document.getElementById('m-avatar').src = item.team.avatar;
                }
                ui.style.display = 'none';
                res.style.display = 'block';
            }, 2000);
        }

        function filterCategory(cat, el) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            const filtered = cat === "æ¨è" ? videoData : videoData.filter(v => v.cat === cat);
            initSwiper(filtered);
        }

        function submitSurvey() {
            const data = {
                cat: document.querySelector('input[name="cat"]:checked')?.value,
                reason: document.getElementById('reason').value,
                time: new Date().toLocaleString()
            };
            console.log("è°ƒç ”æ•°æ®å·²å­˜å…¥æœ¬åœ°:", data);
            localStorage.setItem('survey_' + Date.now(), JSON.stringify(data));
            closeModal('surveyModal');
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            if (swiper && swiper.activeIndex !== undefined) {
                const videos = document.querySelectorAll('video');
                if (videos[swiper.activeIndex]) {
                    videos[swiper.activeIndex].play();
                }
            }
        }

        function formatCount(count) {
            if (count >= 10000) {
                return (count / 10000).toFixed(1) + 'w';
            } else if (count >= 1000) {
                return (count / 1000).toFixed(1) + 'k';
            }
            return count.toString();
        }

        async function toggleLike(videoId, index) {
            const btn = document.getElementById(`likeBtn_${videoId}`);
            const countEl = document.getElementById(`likeCount_${videoId}`);
            const isLiked = btn.classList.contains('liked');
            
            if (isLiked) {
                btn.classList.remove('liked');
                const currentCount = videoStats[videoId]?.likes || 0;
                videoStats[videoId] = { ...videoStats[videoId], likes: Math.max(0, currentCount - 1) };
            } else {
                btn.classList.add('liked');
                const currentCount = videoStats[videoId]?.likes || 0;
                videoStats[videoId] = { ...videoStats[videoId], likes: currentCount + 1 };
                localStorage.setItem(`liked_${videoId}`, 'true');
            }
            countEl.textContent = formatCount(videoStats[videoId].likes);
            
            try {
                const response = await fetch(`/api/likes/${videoId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: isLiked ? 'unlike' : 'like' })
                });
                if (response.ok) {
                    const data = await response.json();
                    videoStats[videoId] = data.stats;
                    countEl.textContent = formatCount(data.stats.likes);
                }
            } catch (error) {
                console.error('ç‚¹èµå¤±è´¥:', error);
                if (isLiked) {
                    btn.classList.add('liked');
                } else {
                    btn.classList.remove('liked');
                    localStorage.removeItem(`liked_${videoId}`);
                }
            }
        }

        async function showComments(videoId) {
            const modal = document.getElementById('commentModal');
            const commentsList = document.getElementById('commentsList');
            modal.style.display = 'flex';
            
            try {
                const response = await fetch(`/api/comments/${videoId}`);
                if (response.ok) {
                    const data = await response.json();
                    videoComments[videoId] = data.comments;
                    renderComments(videoId);
                } else {
                    renderComments(videoId);
                }
            } catch (error) {
                console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
                renderComments(videoId);
            }
        }

        function renderComments(videoId) {
            const commentsList = document.getElementById('commentsList');
            const comments = videoComments[videoId] || [];
            const video = videoData.find(v => v.id === videoId);
            
            if (comments.length === 0 && video) {
                const presetComments = getPresetComments(video.cat);
                commentsList.innerHTML = presetComments.map((comment, idx) => `
                    <div class="comment-item">
                        <div class="comment-user">@ç”¨æˆ·${idx + 1}</div>
                        <div class="comment-content">${comment}</div>
                        <div class="comment-time">${getTimeAgo(idx)}</div>
                    </div>
                `).join('');
            } else {
                commentsList.innerHTML = comments.map(comment => `
                    <div class="comment-item">
                        <div class="comment-user">${comment.user_name || '@åŒ¿åç”¨æˆ·'}</div>
                        <div class="comment-content">${comment.content}</div>
                        <div class="comment-time">${formatTime(comment.created_at)}</div>
                    </div>
                `).join('');
            }
        }

        function getPresetComments(category) {
            const presets = {
                'ç¾é£Ÿ': ["çœ‹èµ·æ¥å¾ˆå¥½åƒ", "åœ¨å“ªé‡Œ", "å¤šå°‘é’±", "æƒ³å»è¯•è¯•"],
                'å­¦ä¹ ': ["åŠ æ²¹", "æ”¶è—äº†", "å¾ˆæœ‰ç”¨", "å…±å‹‰"],
                'æ—…è¡Œ': ["å¥½æƒ³å»", "æ”»ç•¥æ”¶è—", "å¤ªç¾äº†", "æ±‚åœ°å€"],
                'æ¸¸æˆ': ["å¸¦æˆ‘", "å‰å®³", "åŠ å¥½å‹", "ä¸€èµ·ç©"],
                'æ ¡å›­ç”Ÿæ´»': ["åŒæ ¡", "å¥½ç¾¡æ…•", "ç‚¹èµ", "æ”¯æŒ"]
            };
            return presets[category] || ["ä¸é”™", "ç‚¹èµ", "æ”¯æŒ", "åŠ æ²¹"];
        }

        async function addComment() {
            const input = document.getElementById('newComment');
            const content = input.value.trim();
            if (!content) return;
            
            const slide = swiper.slides[swiper.activeIndex];
            const videoId = slide ? parseInt(slide.getAttribute('data-id'), 10) : null;
            if (videoId == null) return;
            
            const newComment = {
                id: Date.now(),
                video_id: videoId,
                content: content,
                user_name: '@æ¸¸å®¢' + Math.floor(Math.random() * 1000),
                created_at: new Date().toISOString()
            };
            
            if (!videoComments[videoId]) {
                videoComments[videoId] = [];
            }
            videoComments[videoId].push(newComment);
            renderComments(videoId);
            input.value = '';
            
            const countEl = document.getElementById(`commentCount_${videoId}`);
            if (countEl) {
                const currentCount = videoStats[videoId]?.comments || 0;
                videoStats[videoId] = { ...videoStats[videoId], comments: currentCount + 1 };
                countEl.textContent = formatCount(videoStats[videoId].comments);
            }
            
            try {
                const response = await fetch(`/api/comments/${videoId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: content })
                });
                if (response.ok) {
                    const data = await response.json();
                    videoComments[videoId] = data.comments;
                    renderComments(videoId);
                }
            } catch (error) {
                console.error('æ·»åŠ è¯„è®ºå¤±è´¥:', error);
            }
        }

        async function shareVideo(videoId) {
            const shareUrl = 'https://short-video-1hg1.vercel.app/';
            const video = videoData.find(v => v.id === videoId);
            const shareText = `${video?.desc || 'åˆ†äº«ä¸€ä¸ªæœ‰è¶£çš„è§†é¢‘'}`;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'çŸ­è§†é¢‘åˆ†äº«',
                        text: shareText,
                        url: shareUrl
                    });
                    await updateShareCount(videoId);
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        copyToClipboard(shareUrl);
                    }
                }
            } else {
                copyToClipboard(shareUrl);
                await updateShareCount(videoId);
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                });
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }
        }

        async function updateShareCount(videoId) {
            const countEl = document.getElementById(`shareCount_${videoId}`);
            if (countEl) {
                const currentCount = videoStats[videoId]?.shares || 0;
                videoStats[videoId] = { ...videoStats[videoId], shares: currentCount + 1 };
                countEl.textContent = formatCount(videoStats[videoId].shares);
            }
            
            try {
                await fetch(`/api/shares/${videoId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
            } catch (error) {
                console.error('æ›´æ–°åˆ†äº«æ•°å¤±è´¥:', error);
            }
        }

        function formatTime(timeString) {
            if (!timeString) return 'åˆšåˆš';
            const time = new Date(timeString);
            const now = new Date();
            const diff = now - time;
            const minutes = Math.floor(diff / 60000);
            if (minutes < 1) return 'åˆšåˆš';
            if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}å°æ—¶å‰`;
            const days = Math.floor(hours / 24);
            return `${days}å¤©å‰`;
        }

        function getTimeAgo(index) {
            const times = ['åˆšåˆš', '5åˆ†é’Ÿå‰', '1å°æ—¶å‰', '2å°æ—¶å‰'];
            return times[index] || 'åˆšåˆš';
        }

        async function loadVideoStats() {
            try {
                const response = await fetch('/api/videos/stats');
                if (response.ok) {
                    const data = await response.json();
                    videoStats = data.stats || {};
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        initSwiper(videoData);
    </script>
</body>
</html>